name: Precompute gnomAD BCF files

on:
  workflow_dispatch:
    inputs:
      af:
        description: "Allele-frequency threshold (e.g. 0.10)"
        required: true
        default: "0.10"
        type: choice
        options:
          - "0.10"
          - "0.05"
          - "0.01"
      chromosomes:
        description: "Chromosomes (space-separated or 'all')"
        required: true
        default: "all"
      gnomad_version:
        description: "gnomAD version"
        required: true
        default: "4.1"

  # Pre-compute weekly to keep BCF files fresh
  schedule:
    - cron: '0 3 * * 0'  # Sunday 3 AM UTC

jobs:
  precompute:
    name: Precompute gnomAD BCF with Hail
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to create releases
    steps:
      - uses: actions/checkout@v4

      - name: Set default values for scheduled runs
        id: defaults
        run: |
          AF="${{ github.event.inputs.af }}"
          CHR="${{ github.event.inputs.chromosomes }}"
          GNOMAD_VERSION="${{ github.event.inputs.gnomad_version }}"

          echo "af=${AF:-0.10}" >> $GITHUB_OUTPUT
          echo "chromosomes=${CHR:-all}" >> $GITHUB_OUTPUT
          echo "gnomad_version=${GNOMAD_VERSION:-4.1}" >> $GITHUB_OUTPUT

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bcftools tabix

      - name: Install Hail
        run: |
          pip install hail

      - name: Make export script executable
        run: chmod +x scripts/export_gnomad_hail.py

      - name: Check if BCF already exists in releases
        id: check-existing
        run: |
          AF="${{ steps.defaults.outputs.af }}"
          CHR="${{ steps.defaults.outputs.chromosomes }}"
          GNOMAD_VERSION="${{ steps.defaults.outputs.gnomad_version }}"

          # Construct expected filenames and tag
          CHR_SUFFIX=$(echo "$CHR" | tr ' ' '_')
          CHR_TAG=$(echo "$CHR" | tr ' ' '-')

          if [ "$CHR" = "all" ]; then
            BCF_NAME="gnomad_v${GNOMAD_VERSION}_GRCh38_af${AF}.bcf"
            RELEASE_TAG="bcf-gnomad-v${GNOMAD_VERSION}-af${AF}-genome"
          else
            BCF_NAME="gnomad_v${GNOMAD_VERSION}_GRCh38_${CHR_SUFFIX}_af${AF}.bcf"
            RELEASE_TAG="bcf-gnomad-v${GNOMAD_VERSION}-af${AF}-${CHR_TAG}"
          fi

          echo "bcf-name=${BCF_NAME}" >> $GITHUB_OUTPUT
          echo "release-tag=${RELEASE_TAG}" >> $GITHUB_OUTPUT

          # Check if release already exists
          RELEASE_URL="https://github.com/${{ github.repository }}/releases/download/${RELEASE_TAG}/${BCF_NAME}"

          echo "Checking for existing BCF at: ${RELEASE_URL}"

          if wget --spider "${RELEASE_URL}" 2>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "✓ BCF already exists in releases - skipping regeneration"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "✗ BCF not found - will generate new file"
          fi

      - name: Export gnomAD data with Hail
        if: steps.check-existing.outputs.exists == 'false'
        id: export
        run: |
          AF="${{ steps.defaults.outputs.af }}"
          CHR="${{ steps.defaults.outputs.chromosomes }}"
          GNOMAD_VERSION="${{ steps.defaults.outputs.gnomad_version }}"
          BCF_NAME="${{ steps.check-existing.outputs.bcf-name }}"

          # Build chromosome arguments
          if [ "$CHR" != "all" ]; then
            CHR_ARGS="--chr ${CHR}"
          else
            CHR_ARGS=""
          fi

          echo "Computing BCF with Hail (this may take 10-30 minutes)..."

          # Run the export script
          python scripts/export_gnomad_hail.py \
            --output "${BCF_NAME}" \
            --af "${AF}" \
            --genome GRCh38 \
            --gnomad-version "${GNOMAD_VERSION}" \
            ${CHR_ARGS}

      - name: Verify BCF file
        if: steps.check-existing.outputs.exists == 'false'
        run: |
          BCF_NAME="${{ steps.check-existing.outputs.bcf-name }}"

          echo "Verifying newly generated BCF file..."

          # Verify the BCF file
          bcftools view -h "${BCF_NAME}" | head -20

          # Get file size
          ls -lh "${BCF_NAME}"

          # Count variants
          VARIANT_COUNT=$(bcftools view -H "${BCF_NAME}" | wc -l)
          echo "Total variants: ${VARIANT_COUNT}"

      - name: Upload BCF as artifact (safety backup)
        if: steps.check-existing.outputs.exists == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: gnomad-bcf-${{ steps.check-existing.outputs.release-tag }}
          path: |
            ${{ steps.check-existing.outputs.bcf-name }}
            ${{ steps.check-existing.outputs.bcf-name }}.csi
          retention-days: 7
          if-no-files-found: error

      - name: Delete existing release and tag if present (cleanup from failed runs)
        if: steps.check-existing.outputs.exists == 'false'
        continue-on-error: true
        run: |
          TAG="${{ steps.check-existing.outputs.release-tag }}"
          echo "Checking if release ${TAG} exists..."

          # Delete release if it exists
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Deleting existing release ${TAG}..."
            gh release delete "${TAG}" --yes --cleanup-tag
          else
            echo "No existing release found"
          fi

          # Also delete the tag if it exists (in case release was already deleted)
          if git ls-remote --tags origin | grep -q "refs/tags/${TAG}"; then
            echo "Deleting orphaned tag ${TAG}..."
            git push --delete origin "${TAG}" || true
          else
            echo "No orphaned tag found"
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create GitHub Release with gh CLI
        if: steps.check-existing.outputs.exists == 'false'
        run: |
          TAG="${{ steps.check-existing.outputs.release-tag }}"
          BCF_NAME="${{ steps.check-existing.outputs.bcf-name }}"

          # Create release notes
          cat > release_notes.md <<'EOF'
          Pre-computed gnomAD v${{ steps.defaults.outputs.gnomad_version }} BCF file

          **Configuration:**
          - Allele Frequency: >= ${{ steps.defaults.outputs.af }}
          - Chromosomes: ${{ steps.defaults.outputs.chromosomes }}
          - Genome Build: GRCh38
          - gnomAD Version: ${{ steps.defaults.outputs.gnomad_version }}
          - Dataset: Joint WES+WGS

          **INFO Fields:**
          - AF: Weighted average allele frequency across all samples
          - AC: Allele count

          **Usage:**
          ```bash
          # Download
          wget https://github.com/${{ github.repository }}/releases/download/${TAG}/${BCF_NAME}
          wget https://github.com/${{ github.repository }}/releases/download/${TAG}/${BCF_NAME}.csi

          # Use with VCFstash
          vcfstash stash-init --vcf ${BCF_NAME} --output cache -y params.yaml
          ```
          EOF

          # Create release with assets in a single command (prevents immutability issue)
          gh release create "${TAG}" \
            --title "gnomAD BCF: AF=${{ steps.defaults.outputs.af }}, Chr=${{ steps.defaults.outputs.chromosomes }}" \
            --notes-file release_notes.md \
            "${BCF_NAME}" \
            "${BCF_NAME}.csi"
        env:
          GH_TOKEN: ${{ github.token }}
