name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write

jobs:
  build-test:
    name: Build + test + dist
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.meta.outputs.version }}
      is_prerelease: ${{ steps.meta.outputs.is_prerelease }}
      tag: ${{ steps.meta.outputs.tag }}
    env:
      BCFTOOLS_VERSION: "1.22"
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.13"

      - name: Set up uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: Create virtual environment
        run: uv venv .venv

      - name: Install dependencies
        run: uv pip install --python .venv/bin/python -e ".[dev]"

      - name: Build bcftools and htslib (>=1.20)
        run: |
          set -euo pipefail

          fetch() {
            # fetch <url1> <url2> <out>
            # Use retries to survive transient GitHub/CDN 5xx.
            local url1="$1"
            local url2="$2"
            local out="$3"
            echo "Downloading: $url1"
            if ! curl -fsSL --retry 6 --retry-all-errors --retry-delay 5 -o "$out" "$url1"; then
              echo "Primary download failed; trying fallback: $url2"
              curl -fsSL --retry 6 --retry-all-errors --retry-delay 5 -o "$out" "$url2"
            fi
          }

          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            ca-certificates \
            curl \
            libbz2-dev \
            libcurl4-openssl-dev \
            liblzma-dev \
            libssl-dev \
            zlib1g-dev

          # Build and install htslib (provides bgzip and tabix)
          fetch \
            "https://github.com/samtools/htslib/releases/download/${BCFTOOLS_VERSION}/htslib-${BCFTOOLS_VERSION}.tar.bz2" \
            "https://codeload.github.com/samtools/htslib/tar.gz/refs/tags/${BCFTOOLS_VERSION}" \
            htslib.tar.bz2
          tar -xjf htslib.tar.bz2
          cd "htslib-${BCFTOOLS_VERSION}"
          ./configure --prefix="${GITHUB_WORKSPACE}/.local"
          make -j2
          make install
          cd ..

          # Build and install bcftools
          fetch \
            "https://github.com/samtools/bcftools/releases/download/${BCFTOOLS_VERSION}/bcftools-${BCFTOOLS_VERSION}.tar.bz2" \
            "https://codeload.github.com/samtools/bcftools/tar.gz/refs/tags/${BCFTOOLS_VERSION}" \
            bcftools.tar.bz2
          tar -xjf bcftools.tar.bz2
          cd "bcftools-${BCFTOOLS_VERSION}"
          ./configure --prefix="${GITHUB_WORKSPACE}/.local"
          make -j2
          make install

          "${GITHUB_WORKSPACE}/.local/bin/bcftools" --version | head -n1
          "${GITHUB_WORKSPACE}/.local/bin/bgzip" --version
          "${GITHUB_WORKSPACE}/.local/bin/tabix" --version

      - name: Add built tools to PATH
        run: echo "${GITHUB_WORKSPACE}/.local/bin" >> "${GITHUB_PATH}"

      - name: Derive version metadata and validate tag
        id: meta
        run: |
          .venv/bin/python - <<'PY'
          import os
          import sys
          import re
          import tomllib
          from pathlib import Path

          tag = os.environ["GITHUB_REF_NAME"]  # e.g. v0.4.0b0
          if not tag.startswith("v"):
            raise SystemExit(f"Expected tag like vX.Y.Z..., got {tag}")
          tag_version = tag[1:]

          data = tomllib.loads(Path("pyproject.toml").read_text())
          project_version = data["project"]["version"]
          if project_version != tag_version:
            raise SystemExit(
              f"Tag/version mismatch: tag={tag_version} pyproject.toml={project_version}"
            )

          # Minimal prerelease detection: PEP 440 prereleases include aN/bN/rcN.
          is_prerelease = bool(re.search(r"(a|b|rc)\d+$", project_version))

          out = Path(os.environ["GITHUB_OUTPUT"])
          out.write_text(
            f"version={project_version}\n"
            f"is_prerelease={'true' if is_prerelease else 'false'}\n"
            f"tag={tag}\n"
          )
          PY

      - name: Run tests
        env:
          VCFCACHE_BCFTOOLS: ${{ github.workspace }}/.local/bin/bcftools
        run: .venv/bin/python -m pytest -q

      - name: Build distributions
        run: .venv/bin/python -m build

      - name: Upload dist artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/*

  github-release:
    name: GitHub Release
    runs-on: ubuntu-latest
    needs: [build-test]
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build-test.outputs.tag }}
          prerelease: ${{ needs.build-test.outputs.is_prerelease == 'true' }}
          files: dist/*

  publish-testpypi:
    name: Publish to TestPyPI (prerelease)
    runs-on: ubuntu-latest
    needs: [build-test]
    if: needs.build-test.outputs.is_prerelease == 'true'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      - name: Publish
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          repository-url: https://test.pypi.org/legacy/
          password: ${{ secrets.TEST_PYPI_API_TOKEN }}

  publish-pypi:
    name: Publish to PyPI (final)
    runs-on: ubuntu-latest
    needs: [build-test]
    if: needs.build-test.outputs.is_prerelease != 'true'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist
      - name: Publish
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          password: ${{ secrets.PYPI_API_TOKEN }}

  docker:
    name: Build + push Docker
    runs-on: ubuntu-latest
    needs: [build-test]
    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/vcfcache
          tags: |
            type=raw,value=v${{ needs.build-test.outputs.version }}
            type=raw,value=latest,enable=${{ needs.build-test.outputs.is_prerelease != 'true' }}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.vcfcache
          target: final
          push: true
          tags: ${{ steps.meta.outputs.tags }}
