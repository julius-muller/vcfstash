# Build stage with full-featured environment
FROM python:3.13-slim AS builder

# Install build dependencies
RUN apt update && apt install -y \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install uv package manager
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:${PATH}"

# Set working directory
WORKDIR /build

# Copy necessary files for installation and testing
COPY pyproject.toml README.md ./
COPY vcfcache ./vcfcache/
COPY tools ./tools/
COPY resources ./resources/
COPY tests ./tests/

# Make bcftools executable
RUN chmod +x /build/tools/bcftools

# Create virtual environment with all dependencies
# Note: hatchling and editables are build-time dependencies for editable installs
RUN uv venv /build/venv && \
    . /build/venv/bin/activate && \
    uv pip install --no-cache-dir hatchling editables && \
    uv pip install --no-cache-dir -e ".[dev]" && \
    rm -rf ~/.cache

# Production stage
FROM python:3.13-slim

# Install runtime dependencies
RUN apt update && apt install -y \
    openjdk-17-jre-headless \
    procps \
    tabix \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy only necessary files from builder
COPY --from=builder /build/venv /app/venv
COPY --from=builder /build/vcfcache /app/vcfcache
COPY --from=builder /build/tools /app/tools
COPY --from=builder /build/resources /app/resources
COPY --from=builder /build/tests /app/tests
COPY --from=builder /build/pyproject.toml /app/

# Set environment variables
ENV PATH="/app/venv/bin:${PATH}"
ENV PYTHONPATH="/app:${PYTHONPATH}"
ENV VCFCACHE_ROOT="/app"

# Create a vcfcache executable link in /usr/local/bin
RUN echo '#!/bin/bash' > /usr/local/bin/vcfcache && \
    echo 'source /app/venv/bin/activate' >> /usr/local/bin/vcfcache && \
    echo 'python -m vcfcache.cli "$@"' >> /usr/local/bin/vcfcache && \
    chmod +x /usr/local/bin/vcfcache

# Create entrypoint script
RUN echo '#!/bin/bash' > /app/entrypoint.sh && \
    echo 'source /app/venv/bin/activate' >> /app/entrypoint.sh && \
    echo 'if [ "$1" = "test" ]; then' >> /app/entrypoint.sh && \
    echo '    shift' >> /app/entrypoint.sh && \
    echo '    cd /app && VCFCACHE_CMD=/usr/local/bin/vcfcache python -m pytest tests "$@"' >> /app/entrypoint.sh && \
    echo 'elif [ "$1" = "shell" ]; then' >> /app/entrypoint.sh && \
    echo '    exec /bin/bash' >> /app/entrypoint.sh && \
    echo 'else' >> /app/entrypoint.sh && \
    echo '    python -m vcfcache.cli "$@"' >> /app/entrypoint.sh && \
    echo 'fi' >> /app/entrypoint.sh && \
    chmod +x /app/entrypoint.sh

# Use the entrypoint script
ENTRYPOINT ["/app/entrypoint.sh"]

# Default command shows help
CMD ["--help"]